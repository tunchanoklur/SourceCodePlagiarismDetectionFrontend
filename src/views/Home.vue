<template>
  <div>
    <v-card>
      <v-card-title class="headline font-weight-regular black white--text">
        <span style="font-size:32px">
          <b>Home</b>
        </span>
      </v-card-title>
      <v-card-text>
        <v-layout row wrap align-center>
          <v-flex xs12 md12 lg12>
            <br>
              <v-col>
                <v-card
                  class="mx-auto"
                  outlined
                >
                  <div class="text-center">
                    <MultifileInput filetype=".c" label="Select source code files" :value="filelist" v-model="filelist"/>
                    <v-btn rounded color="rgba(0,0,0,.87)" dark @click="submit()">Submit</v-btn>
                  </div>
                  <br>
                </v-card>
              </v-col>
            <br>
            <v-col>
              <v-card
                class="mx-auto"
                outlined
              >
              <br>
                <div v-if="loading" class="text-center">
                  <v-progress-circular
                    :size="70"
                    :width="7"
                    color="black"
                    indeterminate
                  ></v-progress-circular>
                </div>
                <div v-if="!loading && similarity_score.length>0" class="text-center">
                  <DataTable
                    :headers="datatable_headers"
                    :fields="datatable_field"
                    :datas="formattedSimScore"
                  ></DataTable>
                </div>
              <br>
              </v-card>
            </v-col>
          </v-flex>
        </v-layout>
      </v-card-text>
    </v-card>
  </div>
</template>

<script>
import MultifileInput from "@/components/MultifileInput"
import DataTable from "@/components/DataTable"
import axios from "axios"
export default {
  name: 'Home',
  components: {
    MultifileInput,DataTable
  },
  data:function(){
    return{
      filelist:[],
      filelist_processed:[],
      similarity_score:[],
      similar_loc:[],
      filename_list:[],
      fileinfo_list:[],
      loading:false,
      datatable_headers: ["Reference file", "Comparison file", "Similarity score"],
      datatable_field: ["ref_filename","comp_filename","sim_score"]
    }
  },
  watch:{
    filelist: function(){
      this.filelist_processed = this.processFile(this.filelist)
    }
  },
  computed:{
    formattedSimScore: function(){
      let dup = [...this.similarity_score]
      let formatted = []
      dup.forEach((row,i)=>{
        row.forEach((data,j)=>{
          if(i!==j && data!==1000){
            formatted.push({
              ref_index: i,
              comp_index: j,
              ref_filename: this.filename_list[i],
              comp_filename: this.filename_list[j],
              sim_score: data
            })
          }
        })
      })
      return formatted
    }
  },
  methods:{
    processFile(files) {
      let result = []
      result = []
      Array.from(files).forEach((file,key) => {
        const fileReader = new FileReader();
        const getResult = new Promise(() => {
          fileReader.onload = e => {
            result.push({
              id: key,
              filename: file.name,
              fileinfo: e.target.result.replace(/\\n/gim,`\\\\n`)
            });
          };
        });

        fileReader.readAsText(file);
        return getResult.then(file => {
          return file;
        });
      });
      return result
    },
    async submit(){
      this.loading = true
      await axios.post('/getsimscore',{filelist:this.filelist_processed})
      .then((result) => {
        this.similarity_score = result.data["score"]
        this.similar_loc = result.data["loc"]
        this.filename_list = result.data["filelist_name"]
        this.fileinfo_list = result.data["filelist_data"]
        this.loading = false
        // eslint-disable-next-line
        console.log("DONE")
      })
      .catch((err) => {
        this.loading = false
        alert(err)
      })
    }
  },
};
</script>
